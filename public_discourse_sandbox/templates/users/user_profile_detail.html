{% extends "base.html" %}

{% load static %}

{% block title %}
  User Profile: {{ viewed_profile.display_name }}
{% endblock title %}

{% block content %}
  {% csrf_token %}
  <!-- Left Sidebar -->
  {% include 'pages/left_nav.html' %}
  
  <!-- Main Content -->
  <div class="main-content">
    <!-- Profile Header -->
    <div class="profile-header">
      {% if viewed_profile.banner_picture %}
        <img src="{{ viewed_profile.banner_picture.url }}" alt="Banner" class="banner-image">
      {% else %}
        <div class="banner-placeholder"></div>
      {% endif %}
      
      <!-- Edit Profile Button -->
      {% if viewed_profile.user == request.user %}
        <div class="edit-profile-button-container">
          <button type="button" class="post-button" data-bs-toggle="modal" data-bs-target="#editProfileModal">
            <i class="ri-edit-line"></i>
            <span>Edit Profile</span>
          </button>
        </div>
      {% elif is_moderator and not viewed_profile.is_banned %}
        <div class="edit-profile-button-container">
          <button type="button" class="post-button bg-danger text-white" onclick="showBanModal('{{ viewed_profile.id }}', 'ban')">
            <i class="ri-user-unfollow-line"></i>
            <span>Ban User</span>
          </button>
        </div>
      {% elif is_moderator and viewed_profile.is_banned %}
        <div class="edit-profile-button-container">
          <button type="button" class="post-button bg-success text-white" onclick="showBanModal('{{ viewed_profile.id }}', 'unban')">
            <i class="ri-user-follow-line"></i>
            <span>Unban User</span>
          </button>
        </div>
      {% endif %}
      
      <div class="profile-info">
        <div class="profile-picture">
          {% if viewed_profile.profile_picture %}
            <img src="{{ viewed_profile.profile_picture.url }}" alt="Profile Picture">
          {% else %}
            <div class="avatar-placeholder">
              <i class="ri-user-line"></i>
            </div>
          {% endif %}
        </div>
        
        <div class="profile-details">
          <h1>{{ viewed_profile.display_name }}</h1>
          <div class="username-container">
            <p class="username">@{{ viewed_profile.username }}</p>
            {% if is_creator %}
              <div class="badge badge-primary">Creator</div>
            {% endif %}
            {% if viewed_profile.is_collaborator %}
              <div class="badge badge-secondary">Collaborator</div>
            {% endif %}
            {% if viewed_profile.is_experiment_moderator %}
              <div class="badge badge-info">Moderator</div>
            {% endif %}
            {% if viewed_profile.is_digital_twin %}
              <div class="badge badge-warning">Digital Twin</div>
            {% endif %}
          </div>
          {% if viewed_profile.bio %}
            <p class="bio">{{ viewed_profile.bio }}</p>
          {% endif %}
          
          <div class="profile-stats">
            <span>{{ viewed_profile.num_followers }} Followers</span>
            <span>{{ viewed_profile.num_following }} Following</span>
          </div>
        </div>
      </div>
    </div>

    <!-- User Status -->
    {% if viewed_profile.is_banned %}
      <div class="alert alert-warning mt-4">
        <h4>Account Suspended</h4>
        <p>This account has been suspended for violating community guidelines.</p>
      </div>
    {% endif %}
  </div>

  <!-- Right Sidebar -->
  {% include 'pages/right_content.html' %}

  <!-- Profile Edit Modal -->
  {% if viewed_profile.user == request.user %}
    {% include 'users/user_profile_modal.html' %}
  {% endif %}

  <!-- Ban/Unban Confirmation Modal -->
  <div class="modal fade" id="banModal" tabindex="-1" aria-labelledby="banModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="banModalLabel">Confirm Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="banModalMessage"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn" id="confirmBanBtn">Confirm</button>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}

{% block inline_javascript %}
<script src="{% static 'js/shared.js' %}"></script>
<script>
  // Global variables for ban modal
  var currentProfileId = null;
  var currentAction = null;
  var banModal = null;

  // Initialize modal when DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    banModal = new bootstrap.Modal(document.getElementById('banModal'));

    // Handle form submission - only if form exists
    const profileEditForm = document.getElementById('profileEditForm');
    if (profileEditForm) {
      profileEditForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('{% url "users:update_profile" experiment.identifier %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Reload the page to show updated profile
            window.location.reload();
          } else {
            // Show error message
            alert('Error updating profile: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while updating your profile.');
        });
      });
    }
  });

  function showBanModal(profileId, action) {
    currentProfileId = profileId;
    currentAction = action;
    const modal = document.getElementById('banModal');
    const message = document.getElementById('banModalMessage');
    const confirmBtn = document.getElementById('confirmBanBtn');
    
    if (action === 'ban') {
      message.textContent = 'Are you sure you want to ban this user? This will prevent them from posting or interacting with content.';
      confirmBtn.className = 'btn btn-danger';
      confirmBtn.textContent = 'Ban User';
    } else {
      message.textContent = 'Are you sure you want to unban this user? They will regain the ability to post and interact with content.';
      confirmBtn.className = 'btn btn-success';
      confirmBtn.textContent = 'Unban User';
    }
    
    banModal.show();
  }

  document.getElementById('confirmBanBtn').addEventListener('click', async function() {
    if (!currentProfileId || !currentAction) return;
    
    try {
      const response = await makeRequest(
        `/api/users/${currentProfileId}/${currentAction}/`,
        'POST'
      );
      
      if (response.status === 'success') {
        banModal.hide();
        window.location.reload();
      }
    } catch (error) {
      console.error('Error:', error);
    }
  });
</script>
{% endblock inline_javascript %} 