{% load static %}
{% csrf_token %}
<!-- Posts List -->
<style>
    .repost-button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
<div class="post-feed">
    {% for post in posts %}
        <article class="post" data-post-id="{{ post.id }}">
            <div class="post-main">
                <a href="{% url 'users:detail' post.user_profile.user.id %}" class="user-avatar">
                    {% if post.user_profile.profile_picture %}
                        <img src="{{ post.user_profile.profile_picture.url }}" alt="Profile Picture" class="avatar-img">
                    {% else %}
                        <div class="avatar-placeholder">
                            <i class="ri-user-line"></i>
                        </div>
                    {% endif %}
                </a>
                <div class="post-content">
                    <!-- Regular post header -->
                    <div class="post-header">
                        <div class="user-info">
                            <a href="{% url 'users:detail' post.user_profile.user.id %}" class="user-name">
                                {{ post.user_profile.display_name }}
                            </a>
                            <a href="{% url 'users:detail' post.user_profile.user.id %}" class="user-handle">
                                @{{ post.user_profile.username }}
                            </a>
                            <span class="dot">Â·</span>
                            <span class="time">{{ post.created_date|timesince }}</span>
                        </div>
                        <div class="post-menu">
                            <button class="menu-button" onclick="togglePostMenu('{{ post.id }}')" title="More">
                                <i class="ri-more-fill"></i>
                            </button>
                            <div id="post-menu-{{ post.id }}" class="post-menu-dropdown" style="display: none;">
                                {% if post.user_profile.user == request.user or is_moderator %}
                                    <button onclick="showDeleteModal('{{ post.id }}')" class="post-menu-item">
                                        <i class="ri-delete-bin-line"></i> Delete
                                    </button>
                                    <!-- {% if is_moderator %}
                                    <button onclick="showBanModal('{{ post.user_profile.id }}', 'ban')" class="post-menu-item">
                                        <i class="ri-user-unfollow-line"></i> Ban User
                                    </button>
                                    {% endif %} -->
                                {% endif %}
                                {% if post.user_profile.user != request.user %}
                                    <button onclick="handleFollow('{{ post.user_profile.id }}')" class="post-menu-item">
                                        <i class="ri-user-follow-line"></i> Follow
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
        
                    <!-- Regular post content -->
                    <div class="post-text">{{ post.content }}</div>
        
                    <!-- Post Actions -->
                    <div class="post-actions">
                        <button class="action-button comment-button" data-post-id="{{ post.id }}" data-authenticated="true" onclick="showCommentPopup('{{ post.id }}')">
                            <i class="ri-chat-1-line"></i>
                            <span>{{ post.comment_count }}</span>
                        </button>
        
                        <button class="action-button repost-button {% if post.user_profile.user == request.user %}disabled{% endif %}" 
                               data-post-id="{{ post.id }}" 
                               data-authenticated="true" 
                               data-is-own-post="{% if post.user_profile.user == request.user %}true{% else %}false{% endif %}"
                               onclick="handleRepost(this, '{{ post.id }}')">
                            <i class="ri-repeat-line"></i>
                            <span>{{ post.num_shares }}</span>
                        </button>
        
                        <button class="action-button like-button {% if post.has_user_voted %}liked{% endif %}" data-post-id="{{ post.id }}" data-authenticated="true" onclick="handleLike(this, '{{ post.id }}')">
                            <i class="{% if post.has_user_voted %}ri-heart-fill{% else %}ri-heart-line{% endif %}"></i>
                            <span>{{ post.num_upvotes }}</span>
                        </button>
                    </div>
                </div>
            </div>
        </article>
    {% empty %}
        <div class="no-posts">
            <p>No posts yet. Be the first to post!</p>
        </div>
    {% endfor %}
</div>

{% include 'components/comment_modal.html' %}

<!-- Delete Confirmation Modal -->
{% include 'components/delete_modal.html' %}

<!-- Ban User Modal -->
{% include 'components/ban_modal.html' %}

<script src="{% static 'js/shared.js' %}"></script>
<script>
function togglePostMenu(postId) {
    const menu = document.getElementById(`post-menu-${postId}`);
    const allMenus = document.querySelectorAll('.post-menu-dropdown');
    
    // Close all other menus
    allMenus.forEach(m => {
        if (m.id !== `post-menu-${postId}`) {
            m.style.display = 'none';
        }
    });
    
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    
    // Close menu when clicking outside
    const closeMenu = (e) => {
        if (!e.target.closest('.post-menu')) {
            menu.style.display = 'none';
            document.removeEventListener('click', closeMenu);
        }
    };
    
    if (menu.style.display === 'block') {
        // Add event listener with a slight delay to avoid immediate triggering
        setTimeout(() => {
            document.addEventListener('click', closeMenu);
        }, 0);
    }
}

function handleRepost(button, postId) {
    // Check if this is the user's own post
    if (button.dataset.isOwnPost === 'true') {
        // alert("You cannot repost your own content");
        console.log("You cannot repost your own content");
        return;
    }
    
    // Check for user confirmation
    if (confirm('Repost this post?')) {
        makeRequest(
            '{% url "repost_post" post_id="00000000-0000-0000-0000-000000000000" %}'.replace('00000000-0000-0000-0000-000000000000', postId),
            'POST'
        )
        .then(data => {
            if (data.success) {
                // Update the share count
                const countSpan = button.querySelector('span');
                countSpan.textContent = data.shares_count;
                
                // Show success message
                alert('Post has been reposted successfully!');
                
                // Refresh the page to show the new post
                window.location.reload();
            }
        })
        .catch(error => {
            if (error.response && error.response.status === 403) {
                // alert('You cannot repost your own content');
                console.log('You cannot repost your own content');
            } else {
                console.error('Error:', error);
                alert('An error occurred while reposting');
            }
        });
    }
}

function handleLike(button, postId) {
    makeRequest(
        '{% url "like_post" post_id="00000000-0000-0000-0000-000000000000" %}'.replace('00000000-0000-0000-0000-000000000000', postId),
        'POST'
    )
    .then(data => {
        // Update the like count
        const countSpan = button.querySelector('span');
        countSpan.textContent = data.upvotes;
        
        // Toggle the like button style
        const icon = button.querySelector('i');
        if (data.is_liked) {
            icon.classList.remove('ri-heart-line');
            icon.classList.add('ri-heart-fill');
            button.classList.add('liked');
        } else {
            icon.classList.remove('ri-heart-fill');
            icon.classList.add('ri-heart-line');
            button.classList.remove('liked');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while liking the post');
    });
}

</script>
