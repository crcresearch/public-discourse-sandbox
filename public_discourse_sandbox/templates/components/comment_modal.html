{% load static %}

<div id="commentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="popup-header">
            <button type="button" class="close-popup" onclick="closeCommentModal()">
                <i class="ri-arrow-left-line"></i>
            </button>
            <h2>Reply</h2>
        </div>
        
        <div class="modal-body" id="commentModalBody">
            <!-- Content will be loaded via HTMX -->
            <div class="loading-spinner" style="text-align: center; padding: 20px;">
                <i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i>
                <p>Loading...</p>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>

<script>
function closeCommentModal() {
    const modal = document.getElementById('commentModal');
    modal.style.display = 'none';
    
    // Clear the modal content and reset to loading state
    const modalBody = document.getElementById('commentModalBody');
    modalBody.innerHTML = `
        <div class="loading-spinner" style="text-align: center; padding: 20px;">
            <i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i>
            <p>Loading...</p>
        </div>
    `;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    
    // Less than 24 hours
    if (diff < 24 * 60 * 60 * 1000) {
        const hours = Math.floor(diff / (60 * 60 * 1000));
        if (hours < 1) {
            const minutes = Math.floor(diff / (60 * 1000));
            return `${minutes}m`;
        }
        return `${hours}h`;
    }
    
    // Less than 7 days
    if (diff < 7 * 24 * 60 * 60 * 1000) {
        const days = Math.floor(diff / (24 * 60 * 60 * 1000));
        return `${days}d`;
    }
    
    // Otherwise return the date
    return date.toLocaleDateString();
}

async function showCommentPopup(postId) {
    // Show modal immediately
    const modal = document.getElementById('commentModal');
    modal.style.display = 'block';
    
    // Close when clicking outside
    window.onclick = function(event) {
        if (event.target == modal) {
            closeCommentModal();
        }
    }
    
    // Load content via HTMX
    const modalBody = document.getElementById('commentModalBody');
    
    // Determine the correct URL based on current page context
    let commentDetailUrl;
    const currentPath = window.location.pathname;
    const experimentMatch = currentPath.match(/^\/([^\/]+)\//);
    
    if (experimentMatch && experimentMatch[1] !== 'api' && experimentMatch[1] !== 'get-replies' && experimentMatch[1] !== 'comment-detail') {
        // We're in an experiment-specific context
        const experimentId = experimentMatch[1];
        commentDetailUrl = `/${experimentId}/comment-detail/${postId}/`;
    } else {
        // Use experiment-agnostic URL
        commentDetailUrl = `/comment-detail/${postId}/`;
    }
    
    // Use HTMX to load the content
    htmx.ajax('GET', commentDetailUrl, {
        target: '#commentModalBody',
        swap: 'innerHTML'
    });
}

// Legacy functions for backward compatibility - these are now handled in the modal content template
function createReplyForm(parentId, isNested = false) {
    // This function is now handled in the modal content template
    console.warn('createReplyForm is deprecated - functionality moved to modal content template');
    return null;
}

function handleReplySubmit(e) {
    // This function is now handled in the modal content template via HTMX
    console.warn('handleReplySubmit is deprecated - functionality moved to HTMX form handling');
}

function renderReplies(replies) {
    // This function is now handled by the Django template
    console.warn('renderReplies is deprecated - functionality moved to Django template rendering');
}

function showReplyForm(replyId) {
    // This function is now defined in the modal content template
    console.warn('showReplyForm should be called after modal content is loaded');
}
</script> 