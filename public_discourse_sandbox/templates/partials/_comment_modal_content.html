{% load static %}

<!-- Original post section -->
<div class="original-post">
    <div class="post-header">
        <div class="user-info">
            <div class="user-avatar">
                {% if post.user_profile.profile_picture %}
                    <img src="{{ post.user_profile.profile_picture.url }}" alt="Profile Picture" class="avatar-img">
                {% else %}
                    <i class="ri-user-3-line"></i>
                {% endif %}
            </div>
            <div>
                <a href="{% url 'user_profile_detail' experiment.identifier post.user_profile.id %}" class="user-name">{{ post.user_profile.display_name }}</a>
                <a href="{% url 'user_profile_detail' experiment.identifier post.user_profile.id %}" class="user-handle">@{{ post.user_profile.username }}</a>
                <span class="dot">路</span>
                <span class="time">{{ post.created_date|timesince }}</span>
            </div>
        </div>
        {% if post.user_profile.user != request.user %}
        <div class="post-menu">
            <button class="menu-button" onclick="togglePostMenu('{{ post.id }}')" title="More">
                <i class="ri-more-fill"></i>
            </button>
            <div id="post-menu-{{ post.id }}" class="post-menu-dropdown" style="display: none;">
                <button onclick="handleFollow('{{ post.user_profile.id }}')" class="post-menu-item">
                    {% if post.is_following %}
                        <i class="ri-user-unfollow-line"></i> Unfollow
                    {% else %}
                        <i class="ri-user-follow-line"></i> Follow
                    {% endif %}
                </button>
            </div>
        </div>
        {% endif %}
    </div>
    
    {% if post.repost_source %}
    <!-- Repost content -->
    <div class="reposted-content">
        <article class="repost-original" data-original-post-id="{{ post.repost_source.id }}">
            <div class="post-main">
                <a href="{% url 'user_profile_detail' experiment.identifier post.repost_source.user_profile.id %}" class="user-avatar">
                    {% if post.repost_source.user_profile.profile_picture %}
                        <img src="{{ post.repost_source.user_profile.profile_picture.url }}" alt="Profile Picture" class="avatar-img">
                    {% else %}
                        <div class="avatar-placeholder">
                            <i class="ri-user-line"></i>
                        </div>
                    {% endif %}
                </a>
                <div class="post-content">
                    <div class="post-header">
                        <div class="user-info">
                            <a href="{% url 'user_profile_detail' experiment.identifier post.repost_source.user_profile.id %}" class="user-name">
                                {{ post.repost_source.user_profile.display_name }}
                            </a>
                            <a href="{% url 'user_profile_detail' experiment.identifier post.repost_source.user_profile.id %}" class="user-handle">
                                @{{ post.repost_source.user_profile.username }}
                            </a>
                            <span class="dot">路</span>
                            <span class="time">{{ post.repost_source.created_date|timesince }}</span>
                        </div>
                    </div>
                    <div class="post-text">{{ post.repost_source.content }}</div>
                </div>
            </div>
        </article>
    </div>
    {% else %}
    <!-- Regular post content -->
    <div class="post-content">{{ post.content }}</div>
    {% endif %}
</div>

<!-- Reply form template - will be cloned and used for both top-level and nested replies -->
<template id="replyFormTemplate">
    {% if not current_user_profile.is_banned %}
    <form class="reply-form" method="post" hx-post="{% url 'create_comment_with_experiment' experiment_identifier=experiment.identifier %}" hx-swap="none">
        {% csrf_token %}
        <input type="hidden" name="parent_post_id" value="{{ post.id }}">
        <div class="comment-input-container">
            <textarea name="content" placeholder="Write your reply" required class="borderless-input"></textarea>
        </div>
        <div class="form-actions">
            <button type="submit" class="post-button" disabled>Reply</button>
        </div>
    </form>
    {% else %}
    <div class="compose-area banned-message">
        <p>Your account has been suspended. You cannot reply to posts at this time.</p>
    </div>
    {% endif %}
</template>

<!-- Main reply form container -->
<div id="mainReplyForm"></div>

<!-- Replies section -->
<div class="replies-section">
    <div id="repliesList">
        {% for reply in replies %}
        <div class="reply-item" data-reply-id="{{ reply.id }}">
            <div class="post-header">
                <div class="user-info">
                    <div class="user-avatar">
                        {% if reply.user_profile.profile_picture %}
                            <img src="{{ reply.user_profile.profile_picture.url }}" alt="{{ reply.user_profile.username }}'s avatar">
                        {% else %}
                            <i class="ri-user-3-line"></i>
                        {% endif %}
                    </div>
                    <div>
                        <a href="{% url 'user_profile_detail' experiment.identifier reply.user_profile.id %}" class="user-name">{{ reply.user_profile.display_name }}</a>
                        <a href="{% url 'user_profile_detail' experiment.identifier reply.user_profile.id %}" class="user-handle">@{{ reply.user_profile.username }}</a>
                        <span class="dot">路</span>
                        <span class="time">{{ reply.created_date|timesince }}</span>
                    </div>
                </div>
                {% if reply.is_author or reply.is_moderator or reply.user_profile.user != request.user %}
                <div class="post-menu">
                    <button class="menu-button" onclick="togglePostMenu('{{ reply.id }}')" title="More">
                        <i class="ri-more-fill"></i>
                    </button>
                    <div id="post-menu-{{ reply.id }}" class="post-menu-dropdown" style="display: none;">
                        {% if reply.is_author or reply.is_moderator %}
                            <button onclick="document.querySelector('.reply-item[data-reply-id=\'{{ reply.id }}\']').style.display = 'none'; showDeleteModal('{{ reply.id }}')" class="post-menu-item">
                                <i class="ri-delete-bin-line"></i> Delete
                            </button>
                        {% endif %}
                        {% if reply.user_profile.user != request.user %}
                            <button onclick="handleFollow('{{ reply.user_profile.id }}')" class="post-menu-item">
                                {% if reply.is_following %}
                                    <i class="ri-user-unfollow-line"></i> Unfollow
                                {% else %}
                                    <i class="ri-user-follow-line"></i> Follow
                                {% endif %}
                            </button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% if reply.repost_source %}
            <!-- Repost content -->
            <div class="reposted-content">
                <article class="repost-original" data-original-post-id="{{ reply.repost_source.id }}">
                    <div class="post-main">
                        <a href="{% url 'user_profile_detail' experiment.identifier reply.repost_source.user_profile.id %}" class="user-avatar">
                            {% if reply.repost_source.user_profile.profile_picture %}
                                <img src="{{ reply.repost_source.user_profile.profile_picture.url }}" alt="Profile Picture" class="avatar-img">
                            {% else %}
                                <div class="avatar-placeholder">
                                    <i class="ri-user-line"></i>
                                </div>
                            {% endif %}
                        </a>
                        <div class="post-content">
                            <div class="post-header">
                                <div class="user-info">
                                    <a href="{% url 'user_profile_detail' experiment.identifier reply.repost_source.user_profile.id %}" class="user-name">
                                        {{ reply.repost_source.user_profile.display_name }}
                                    </a>
                                    <a href="{% url 'user_profile_detail' experiment.identifier reply.repost_source.user_profile.id %}" class="user-handle">
                                        @{{ reply.repost_source.user_profile.username }}
                                    </a>
                                    <span class="dot">路</span>
                                    <span class="time">{{ reply.repost_source.created_date|timesince }}</span>
                                </div>
                            </div>
                            <div class="post-text">{{ reply.repost_source.content }}</div>
                        </div>
                    </div>
                </article>
            </div>
            {% else %}
            <!-- Regular reply content -->
            <div class="post-content">{{ reply.content }}</div>
            {% endif %}
            <div class="nested-reply-container" id="replyForm-{{ reply.id }}"></div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Initialize the main reply form when modal content is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeCommentModal();
});

// Also run when HTMX content is swapped in
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'commentModalBody') {
        initializeCommentModal();
    }
});

function initializeCommentModal() {
    // Create main reply form
    const mainReplyForm = document.getElementById('mainReplyForm');
    if (mainReplyForm) {
        mainReplyForm.innerHTML = '';
        const form = createReplyForm('{{ post.id }}');
        mainReplyForm.appendChild(form);
    }
}

function createReplyForm(parentId, isNested = false) {
    const template = document.getElementById('replyFormTemplate');
    if (!template) return null;
    
    const form = template.content.cloneNode(true);
    const isBanned = form.querySelector('.banned-message') !== null;
    const formElement = form.querySelector(isBanned ? '.compose-area.banned-message' : '.reply-form');
    
    if (!isBanned) {
        // Set up form
        formElement.querySelector('[name="parent_post_id"]').value = parentId;
        if (isNested) {
            formElement.classList.add('nested-reply-form');
        }
        
        // Add input handler for enabling/disabling submit button
        const textarea = formElement.querySelector('textarea');
        const submitButton = formElement.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        
        textarea.addEventListener('input', function() {
            submitButton.disabled = !this.value.trim();
        });
        
        // Handle form submission success
        formElement.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.successful) {
                // Clear the form
                formElement.reset();
                submitButton.disabled = true;
                
                // Refresh the modal content to show new reply
                const postId = '{{ post.id }}';
                const modalBody = document.getElementById('commentModalBody');
                if (modalBody) {
                    htmx.ajax('GET', `{% url 'comment_detail_with_experiment' experiment_identifier=experiment.identifier post_id='00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', postId), {
                        target: '#commentModalBody',
                        swap: 'innerHTML'
                    });
                }
                
                // If this was a nested reply, remove the reply form
                if (formElement.classList.contains('nested-reply-form')) {
                    const container = formElement.closest('.nested-reply-container');
                    if (container) {
                        container.innerHTML = '';
                    }
                }
            }
        });
    } else if (isNested) {
        formElement.classList.add('nested-reply-form');
    }
    
    return formElement;
}

function showReplyForm(replyId) {
    const container = document.getElementById(`replyForm-${replyId}`);
    if (!container) return;
    
    // Remove existing form if present
    container.innerHTML = '';
    // Create and add new form
    const form = createReplyForm(replyId, true);
    if (form) {
        container.appendChild(form);
        // Focus the textarea
        const textarea = form.querySelector('textarea');
        if (textarea) textarea.focus();
    }
}

function togglePostMenu(postId) {
    const menu = document.getElementById(`post-menu-${postId}`);
    if (!menu) return;
    
    if (menu.style.display === 'none') {
        menu.style.display = 'block';
        // Close other open menus
        document.querySelectorAll('.post-menu-dropdown').forEach(dropdown => {
            if (dropdown.id !== `post-menu-${postId}`) {
                dropdown.style.display = 'none';
            }
        });
    } else {
        menu.style.display = 'none';
    }
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.post-menu')) {
        document.querySelectorAll('.post-menu-dropdown').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});
</script> 