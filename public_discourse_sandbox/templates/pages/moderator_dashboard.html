{% extends "base.html" %}

{% load static %}

{% block title %}
  Moderator Dashboard - {{ experiment.name }}
{% endblock title %}

{% block content %}
  {% csrf_token %}
  <!-- Left Sidebar -->
  {% include 'pages/left_nav.html' %}
  
  <!-- Main Content -->
  <div class="main-content">
    <h1>Moderator Dashboard</h1>
    
    <!-- Using context processor's is_moderator -->
    {% if is_moderator %}
      <div class="alert alert-success">
        You have moderator permissions for this experiment.
      </div>
    {% endif %}
    
    <!-- Using mixin's is_moderator (same as above) -->
    {% if is_moderator %}
      <div class="dashboard-section">
        <h2>Banned Users</h2>
        {% if banned_users %}
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Display Name</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for user in banned_users %}
                  <tr>
                    <td>@{{ user.username }}</td>
                    <td>{{ user.display_name }}</td>
                    <td>
                      <button class="btn btn-sm btn-success" 
                              onclick="unbanUser('{{ user.id }}')">
                        Unban
                      </button>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>No banned users in this experiment.</p>
        {% endif %}
      </div>
      
      <div class="dashboard-section">
        <h2>Recent Posts</h2>
        {% if reported_posts %}
          <div class="posts-list">
            {% for post in reported_posts %}
              <div class="post-card">
                <div class="post-header">
                  <span class="username">@{{ post.user_profile.username }}</span>
                  <span class="timestamp">{{ post.created_date|timesince }} ago</span>
                </div>
                <div class="post-content">
                  {{ post.content }}
                </div>
                <div class="post-actions">
                  <button class="btn btn-sm btn-danger" 
                          onclick="deletePost('{{ post.id }}')">
                    Delete
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p>No recent posts to moderate.</p>
        {% endif %}
      </div>
    {% else %}
      <div class="alert alert-danger">
        You do not have permission to view this page.
      </div>
    {% endif %}
  </div>
  
  <!-- Right Sidebar -->
  {% include 'pages/right_content.html' %}
{% endblock content %}

{% block inline_javascript %}
<script>
  function unbanUser(userId) {
    if (confirm('Are you sure you want to unban this user?')) {
      fetch(`/api/users/${userId}/unban/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while unbanning the user.');
      });
    }
  }
  
  function deletePost(postId) {
    if (confirm('Are you sure you want to delete this post?')) {
      fetch(`/api/posts/${postId}/delete/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the post.');
      });
    }
  }
</script>
{% endblock inline_javascript %} 